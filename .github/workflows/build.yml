name: Build and Test

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build:
    name: Windows
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v2

      - name: Setup tools cache
        uses: actions/cache@v1
        id: tools-cache
        with:
          path: C:\hostedtoolcache
          key: ${{ runner.os }}-tools-${{ hashFiles('**/.github/workflows/build.yml') }}
          restore-keys: ${{ runner.os }}-tools-

      - name: Setup MSBuild.exe
        uses: warrenbuckley/Setup-MSBuild@v1

      - name: Setup VSTest.exe
        uses: Malcolmnixon/Setup-VSTest@v2

      # Initializes the CodeQL tools for scanning.
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v1
        with:
          languages: 'cpp'

      - name: Build with MSBuild
        run: msbuild ConsolePacman.sln

      - name: Run tests
        run: vstest.console .\x64\Debug\ConsolePacmanTests.dll

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v1
        with:
          output: ${{ github.workspace }}

      - name: Save CodeQL Analysis Report
        uses: actions/upload-artifact@v2
        with:
          name: cpp-builtin.sarif
          path: ${{ github.workspace }}/*.sarif

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v1
        with:
          # Path to SARIF file relative to the root of the repository
          sarif_file: ${{ github.workspace }}/cpp-builtin.sarif


